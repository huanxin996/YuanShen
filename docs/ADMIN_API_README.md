# Admin ç®¡ç†æ¨¡å—æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç» YuanShen API æ¡†æ¶ä¸­çš„ admin ç®¡ç†æ¨¡å—ç›¸å…³æ¥å£å’ŒåŠŸèƒ½ã€‚

## ğŸŒŸ åŠŸèƒ½æ¦‚è§ˆ

Admin ç®¡ç†æ¨¡å—æ˜¯ YuanShen API æ¡†æ¶çš„æ ¸å¿ƒæ§åˆ¶ä¸­å¿ƒï¼Œæä¾›ä»¥ä¸‹å…³é”®åŠŸèƒ½ï¼š

- **API çŠ¶æ€ç®¡ç†**ï¼šåŠ¨æ€å¯ç”¨/ç¦ç”¨ API è·¯ç”±
- **Token å®‰å…¨ç®¡ç†**ï¼šä¸ºæ¯ä¸ª API é…ç½®ç‹¬ç«‹çš„ Token éªŒè¯
- **è®¿é—®ç»Ÿè®¡ä¸æ•°æ®åˆ†æ**ï¼šå®æ—¶ç›‘æ§ API è°ƒç”¨æƒ…å†µå’Œè¶‹åŠ¿
- **ç³»ç»Ÿèµ„æºç›‘æ§**ï¼šCPUã€å†…å­˜ä½¿ç”¨ç‡åŠè¿è¡Œç¯å¢ƒä¿¡æ¯å±•ç¤º
- **å¯è§†åŒ–ç®¡ç†ç•Œé¢**ï¼šå‹å¥½çš„ Web ç®¡ç†åå°

## ğŸš€ ä¸»è¦æ¥å£

### ç®¡ç†ç•Œé¢åŠæ•°æ®æ¥å£

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | æƒé™è¦æ±‚ |
|------|------|------|---------|
| `/admin/manage` | GET | è·¯ç”±çŠ¶æ€ç®¡ç†ç•Œé¢ | ç®¡ç†å‘˜ |
| `/admin/stats` | GET | APIç»Ÿè®¡å’Œç³»ç»Ÿç›‘æ§ç•Œé¢ | ç®¡ç†å‘˜ |
| `/admin/settings` | GET | ç³»ç»Ÿè®¾ç½®ç•Œé¢ | ç®¡ç†å‘˜ |
| `/admin/action` | POST | æ§åˆ¶ API å¯ç”¨/ç¦ç”¨ | ç®¡ç†å‘˜ |
| `/admin/token/action` | POST | Token é…ç½®ç®¡ç† | ç®¡ç†å‘˜ |
| `/admin/token/query` | POST | æŸ¥è¯¢ Token ä¿¡æ¯å’Œä½¿ç”¨ç»Ÿè®¡ | ç®¡ç†å‘˜ |

### ç®¡ç†åå°åŠŸèƒ½è¯¦è§£

#### `/admin/manage` - è·¯ç”±çŠ¶æ€ç®¡ç†ç•Œé¢

æä¾›ä¸€ä¸ªå¯è§†åŒ–çš„è·¯ç”±ç®¡ç†ç•Œé¢ï¼ŒåŒ…å«ï¼š

- **è·¯ç”±åˆ—è¡¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰ API è·¯ç”±åŠå…¶çŠ¶æ€
- **æœç´¢åŠŸèƒ½**ï¼šå¿«é€ŸæŸ¥æ‰¾ç‰¹å®šè·¯ç”±
- **çŠ¶æ€æ§åˆ¶**ï¼šä¸€é”®å¯ç”¨/ç¦ç”¨ API
- **Token é…ç½®**ï¼šä¸ºæ¯ä¸ª API é…ç½®ç‹¬ç«‹çš„ Token éªŒè¯
- **è®¿é—®ç»Ÿè®¡**ï¼šæ˜¾ç¤ºæ¯ä¸ª API çš„è°ƒç”¨æ¬¡æ•°

**ç•Œé¢ç‰¹æ€§ï¼š**
- å®æ—¶çŠ¶æ€æ˜¾ç¤ºï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰
- Token é…ç½®çŠ¶æ€ï¼ˆæœªå¯ç”¨/é»˜è®¤Token/è‡ªå®šä¹‰Tokenï¼‰
- æ“ä½œæŒ‰é’®ï¼ˆå¯ç”¨/ç¦ç”¨ã€Tokenè®¾ç½®ï¼‰
- æœç´¢è¿‡æ»¤åŠŸèƒ½

#### `/admin/stats` - ç»Ÿè®¡åˆ†æç•Œé¢

æä¾›å…¨é¢çš„ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯å’Œæ•°æ®å¯è§†åŒ–ï¼š

- **æ€»ä½“ç»Ÿè®¡**ï¼šAPI æ€»æ•°ã€æ€»è°ƒç”¨æ¬¡æ•°ã€ç¦ç”¨æ•°é‡
- **çƒ­é—¨æ’è¡Œ**ï¼šè®¿é—®é‡å‰ä¸‰çš„ API
- **è¶‹åŠ¿å›¾è¡¨**ï¼šè¿‡å» 7 å¤©çš„è°ƒç”¨è¶‹åŠ¿
- **é¥¼å›¾åˆ†æ**ï¼šAPI è°ƒç”¨åˆ†å¸ƒæƒ…å†µ
- **ç³»ç»Ÿç›‘æ§**ï¼šCPUã€å†…å­˜ä½¿ç”¨ç‡ã€è¿è¡Œç¯å¢ƒä¿¡æ¯

#### `/admin/action` - API æ§åˆ¶

ç”¨äºåŠ¨æ€æ§åˆ¶ API çš„å¯ç”¨æˆ–ç¦ç”¨çŠ¶æ€ã€‚

**è¯·æ±‚å‚æ•°ï¼ˆè¡¨å•æ•°æ®ï¼‰ï¼š**

```
action: "disable:/maimai/b50"  # æ“ä½œç±»å‹:è·¯å¾„ï¼Œæ ¼å¼ä¸º "enable:è·¯å¾„" æˆ– "disable:è·¯å¾„"
```

**å“åº”ï¼š**
- æˆåŠŸï¼šé‡å®šå‘åˆ°ç®¡ç†ç•Œé¢
- å¤±è´¥ï¼šè¿”å› JSON é”™è¯¯ä¿¡æ¯

#### `/admin/token/action` - Token ç®¡ç†

ç”¨äºé…ç½®å’Œç®¡ç† API çš„ Token éªŒè¯ã€‚

**è¯·æ±‚å‚æ•°ï¼ˆè¡¨å•æ•°æ®ï¼‰ï¼š**

```
api_path: "/maimai/b50"        # API è·¯å¾„
token_action: "enable"         # æ“ä½œç±»å‹
custom_token: "abc123..."      # è‡ªå®šä¹‰ Tokenï¼ˆå¯é€‰ï¼‰
expire_time: 3600000          # è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
```

**æ”¯æŒçš„æ“ä½œç±»å‹ï¼š**
- `enable`ï¼šå¯ç”¨ Token éªŒè¯
- `disable`ï¼šç¦ç”¨ Token éªŒè¯
- `set_custom`ï¼šè®¾ç½®è‡ªå®šä¹‰ Token
- `generate`ï¼šç”Ÿæˆæ–°çš„éšæœº Token
- `remove_custom`ï¼šç§»é™¤è‡ªå®šä¹‰ Tokenï¼Œä½¿ç”¨é»˜è®¤ Token

**å“åº”ï¼š**
- æˆåŠŸï¼šé‡å®šå‘åˆ°ç®¡ç†ç•Œé¢
- å¤±è´¥ï¼šè¿”å› JSON é”™è¯¯ä¿¡æ¯

#### `/admin/token/query` - Token ä¿¡æ¯æŸ¥è¯¢

ç”¨äºæŸ¥è¯¢ API çš„ Token é…ç½®å’Œä½¿ç”¨ç»Ÿè®¡ã€‚

**è¯·æ±‚å‚æ•°ï¼ˆè¡¨å•æ•°æ®ï¼‰ï¼š**

```
api_path: "/maimai/b50"        # API è·¯å¾„
query_type: "info"             # æŸ¥è¯¢ç±»å‹ï¼šinfo æˆ– usage
days: 7                        # ç»Ÿè®¡å¤©æ•°ï¼ˆä»… usage æŸ¥è¯¢éœ€è¦ï¼‰
```

**info æŸ¥è¯¢å“åº”æ ¼å¼ï¼š**

```json
{
  "success": true,
  "query_type": "info",
  "api_path": "/maimai/b50",
  "token_enabled": true,         # Token æ˜¯å¦å¯ç”¨
  "has_custom_token": true,      # æ˜¯å¦æœ‰è‡ªå®šä¹‰ Token
  "custom_token": "abc123...",   # è‡ªå®šä¹‰ Token
  "expire_time_ms": 3600000,     # è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  "default_token": "def456...",  # é»˜è®¤ Token
  "default_expire_ms": 3600000   # é»˜è®¤è¿‡æœŸæ—¶é—´
}
```

**usage æŸ¥è¯¢å“åº”æ ¼å¼ï¼š**

```json
{
  "success": true,
  "query_type": "usage",
  "api_path": "/maimai/b50",
  "days": 7,
  "usage_stats": {
    "stats": {
      "/maimai/b50": {
        "total_success": 150,      # æ€»æˆåŠŸæ¬¡æ•°
        "total_failure": 5,        # æ€»å¤±è´¥æ¬¡æ•°
        "dates": {                 # æ¯æ—¥ç»Ÿè®¡
          "2025-06-15": {
            "success": 30,
            "failure": 1,
            "total": 31
          }
        }
      }
    },
    "summary": {
      "total_apis": 1,
      "date_range": "2025-06-10 to 2025-06-16"
    }
  }
}
```

## ğŸ“Š Token ç®¡ç†ç³»ç»Ÿ

### Token éªŒè¯æœºåˆ¶

1. **é»˜è®¤ Token**ï¼šç³»ç»Ÿå…¨å±€é»˜è®¤ Tokenï¼Œæ‰€æœ‰å¯ç”¨éªŒè¯çš„ API å…±äº«
2. **è‡ªå®šä¹‰ Token**ï¼šä¸ºç‰¹å®š API è®¾ç½®ç‹¬ç«‹çš„ Token
3. **è¿‡æœŸæ—¶é—´**ï¼šToken çš„æœ‰æ•ˆæœŸï¼Œé»˜è®¤ 1 å°æ—¶ï¼ˆ3600000 æ¯«ç§’ï¼‰
4. **éªŒè¯ç»Ÿè®¡**ï¼šè®°å½•æ¯æ¬¡ Token éªŒè¯çš„æˆåŠŸ/å¤±è´¥æƒ…å†µ

### Token é…ç½®æµç¨‹

1. **å¯ç”¨éªŒè¯**ï¼šåœ¨ç®¡ç†ç•Œé¢ç‚¹å‡» Token è®¾ç½®æŒ‰é’®
2. **é€‰æ‹©ç±»å‹**ï¼šä½¿ç”¨é»˜è®¤ Token æˆ–è®¾ç½®è‡ªå®šä¹‰ Token
3. **é…ç½®å‚æ•°**ï¼šè®¾ç½® Token å€¼å’Œè¿‡æœŸæ—¶é—´
4. **ä¿å­˜é…ç½®**ï¼šæäº¤åç«‹å³ç”Ÿæ•ˆ

### å®‰å…¨ç‰¹æ€§

- **ç‹¬ç«‹éªŒè¯**ï¼šæ¯ä¸ª API å¯é…ç½®ç‹¬ç«‹çš„ Token
- **åŠ¨æ€ç®¡ç†**ï¼šæ”¯æŒå®æ—¶å¯ç”¨/ç¦ç”¨ï¼Œæ— éœ€é‡å¯æœåŠ¡
- **ä½¿ç”¨ç»Ÿè®¡**ï¼šè¯¦ç»†è®°å½• Token ä½¿ç”¨æƒ…å†µï¼Œä¾¿äºå®¡è®¡
- **è¿‡æœŸæ§åˆ¶**ï¼šçµæ´»çš„è¿‡æœŸæ—¶é—´è®¾ç½®

## ğŸ“ˆ ç»Ÿè®¡æ•°æ®è¯´æ˜

### API è®¿é—®ç»Ÿè®¡

- `api_count:{path}`ï¼šAPI æ€»è°ƒç”¨æ¬¡æ•°
- `api_daily_stats:{path}`ï¼šAPI æ¯æ—¥è°ƒç”¨ç»Ÿè®¡
- `api_total_daily_stats`ï¼šå…¨ç«™æ¯æ—¥æ€»è°ƒç”¨ç»Ÿè®¡

### Token ä½¿ç”¨ç»Ÿè®¡

- è®°å½•æ¯æ¬¡ Token éªŒè¯çš„ç»“æœ
- æŒ‰æ—¥æœŸç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ¬¡æ•°
- è®¡ç®—æˆåŠŸç‡å’Œè¶‹åŠ¿åˆ†æ

### ç³»ç»Ÿç›‘æ§æ•°æ®

```json
{
  "system_info": {
    "os_info": "Linux 5.4.0",           # æ“ä½œç³»ç»Ÿä¿¡æ¯
    "container_env": "Docker",           # å®¹å™¨ç¯å¢ƒ
    "fastapi_version": "0.95.1",         # FastAPI ç‰ˆæœ¬
    "mem_total": "8.00 GB",              # æ€»å†…å­˜
    "mem_used": "2.50 GB",               # å·²ç”¨å†…å­˜
    "mem_available": "5.50 GB",          # å¯ç”¨å†…å­˜
    "system_mem_percent": 31.25,         # ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡
    "process_mem": "256.00 MB",          # è¿›ç¨‹å†…å­˜ä½¿ç”¨
    "process_percent": "3.1%",           # è¿›ç¨‹å†…å­˜å æ¯”
    "system_cpu_percent": 15.2,          # ç³»ç»Ÿ CPU ä½¿ç”¨ç‡
    "cpu_count": 4,                      # CPU æ ¸å¿ƒæ•°
    "process_cpu_percent": 2.1,          # è¿›ç¨‹ CPU ä½¿ç”¨ç‡
    "server_start_timestamp": 1684234567  # æœåŠ¡å¯åŠ¨æ—¶é—´æˆ³
  }
}
```

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### Python è„šæœ¬æ§åˆ¶APIçŠ¶æ€

```python
import requests

# ç¦ç”¨ç‰¹å®šAPI
def disable_api(api_path):
    url = "https://your-api-domain.com/admin/action"
    data = {
        "action": f"disable:{api_path}"
    }
    
    response = requests.post(url, data=data)
    
    if response.status_code == 303:  # é‡å®šå‘è¡¨ç¤ºæˆåŠŸ
        print(f"æˆåŠŸç¦ç”¨ API: {api_path}")
    else:
        print(f"æ“ä½œå¤±è´¥: {response.text}")

# å¯ç”¨APIçš„TokenéªŒè¯
def enable_token(api_path, custom_token=None, expire_time=3600000):
    url = "https://your-api-domain.com/admin/token/action"
    data = {
        "api_path": api_path,
        "token_action": "set_custom" if custom_token else "enable",
        "expire_time": expire_time
    }
    
    if custom_token:
        data["custom_token"] = custom_token
    
    response = requests.post(url, data=data)
    
    if response.status_code == 303:
        print(f"æˆåŠŸé…ç½® Token: {api_path}")
    else:
        print(f"é…ç½®å¤±è´¥: {response.text}")

# æŸ¥è¯¢Tokenä¿¡æ¯
def get_token_info(api_path):
    url = "https://your-api-domain.com/admin/token/query"
    data = {
        "api_path": api_path,
        "query_type": "info"
    }
    
    response = requests.post(url, data=data)
    info = response.json()
    
    if info.get("success"):
        print(f"API: {info['api_path']}")
        print(f"Tokenå¯ç”¨: {info['token_enabled']}")
        print(f"è‡ªå®šä¹‰Token: {info['has_custom_token']}")
        print(f"è¿‡æœŸæ—¶é—´: {info['expire_time_ms']}ms")
    else:
        print(f"æŸ¥è¯¢å¤±è´¥: {info.get('error')}")

# ä½¿ç”¨ç¤ºä¾‹
disable_api("/maimai/b50")
enable_token("/maimai/b50", "my_custom_token_123", 7200000)
get_token_info("/maimai/b50")
```

### è·å–ä½¿ç”¨ç»Ÿè®¡

```python
def get_token_usage(api_path, days=7):
    url = "https://your-api-domain.com/admin/token/query"
    data = {
        "api_path": api_path,
        "query_type": "usage",
        "days": days
    }
    
    response = requests.post(url, data=data)
    usage = response.json()
    
    if usage.get("success"):
        stats = usage["usage_stats"]["stats"].get(api_path, {})
        if stats:
            print(f"API: {api_path}")
            print(f"æˆåŠŸ: {stats['total_success']} æ¬¡")
            print(f"å¤±è´¥: {stats['total_failure']} æ¬¡")
            print(f"æˆåŠŸç‡: {stats['total_success']/(stats['total_success']+stats['total_failure'])*100:.1f}%")
        else:
            print(f"æš‚æ— ä½¿ç”¨è®°å½•: {api_path}")
    else:
        print(f"æŸ¥è¯¢å¤±è´¥: {usage.get('error')}")

# ä½¿ç”¨ç¤ºä¾‹
get_token_usage("/maimai/b50", 30)
```

## ğŸ¨ ç®¡ç†ç•Œé¢ç‰¹æ€§

### å“åº”å¼è®¾è®¡

- æ”¯æŒæ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯è®¿é—®
- è‡ªé€‚åº”å¸ƒå±€ï¼Œä¼˜åŒ–ä¸åŒå±å¹•å°ºå¯¸æ˜¾ç¤º

### äº¤äº’ä½“éªŒ

- **æ¨¡æ€æ¡†è®¾è®¡**ï¼šToken é…ç½®ä½¿ç”¨æµç•…çš„æ¨¡æ€æ¡†äº¤äº’
- **åŠ¨ç”»æ•ˆæœ**ï¼šé¡µé¢åˆ‡æ¢å’Œæ“ä½œåé¦ˆæœ‰æµç•…çš„æ¸å…¥æ¸å‡ºåŠ¨ç”»
- **å®æ—¶åé¦ˆ**ï¼šæ“ä½œçŠ¶æ€å®æ—¶æ›´æ–°ï¼Œæä¾›æ¸…æ™°çš„è§†è§‰åé¦ˆ
- **æœç´¢è¿‡æ»¤**ï¼šæ”¯æŒå®æ—¶æœç´¢è¿‡æ»¤è·¯ç”±åˆ—è¡¨

### æ•°æ®å¯è§†åŒ–

- **ECharts å›¾è¡¨**ï¼šä½¿ç”¨ä¸“ä¸šå›¾è¡¨åº“å±•ç¤ºç»Ÿè®¡æ•°æ®
- **é¥¼å›¾åˆ†æ**ï¼šAPI è°ƒç”¨åˆ†å¸ƒä¸€ç›®äº†ç„¶
- **è¶‹åŠ¿çº¿å›¾**ï¼šå†å²è°ƒç”¨è¶‹åŠ¿æ¸…æ™°å±•ç¤º
- **å®æ—¶ç›‘æ§**ï¼šç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µå®æ—¶æ›´æ–°

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Token å®‰å…¨**ï¼š
   - å®šæœŸæ›´æ¢ Token ä»¥æé«˜å®‰å…¨æ€§
   - é¿å…åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´ Token
   - åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´

2. **æ€§èƒ½è€ƒè™‘**ï¼š
   - é¿å…é¢‘ç¹å¯ç”¨/ç¦ç”¨APIï¼Œå¯èƒ½å½±å“ç³»ç»Ÿç¨³å®šæ€§
   - Token éªŒè¯ä¼šå¢åŠ è¯·æ±‚å¤„ç†æ—¶é—´
   - ç»Ÿè®¡æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå®šæœŸæ¸…ç†å†å²æ•°æ®

3. **å¤‡ä»½æ•°æ®**ï¼š
   - å®šæœŸå¤‡ä»½ API ç»Ÿè®¡å’Œé…ç½®æ•°æ®
   - Token é…ç½®ä¿¡æ¯å­˜å‚¨åœ¨ `token_configs` è¡¨ä¸­

4. **è®¿é—®æ§åˆ¶**ï¼š
   - ç®¡ç†ç•Œé¢æ— éœ€é¢å¤– Token éªŒè¯
   - æ‰€æœ‰ `/admin/` è·¯å¾„è‡ªåŠ¨æ”¾è¡Œ
   - ç¡®ä¿ç®¡ç†ç•Œé¢çš„ç½‘ç»œè®¿é—®å®‰å…¨

## ğŸ” æ•…éšœæ’æŸ¥

1. **APIçŠ¶æ€ä¿®æ”¹æœªç”Ÿæ•ˆ**
   - æ£€æŸ¥è·¯ç”±ä¿æŠ¤ä¸­é—´ä»¶æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - æŸ¥çœ‹åº”ç”¨æ—¥å¿—ç¡®è®¤æ“ä½œæ˜¯å¦æˆåŠŸ
   - å°è¯•é‡å¯æœåŠ¡

2. **TokenéªŒè¯å¼‚å¸¸**
   - æ£€æŸ¥ Token é…ç½®æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤è¿‡æœŸæ—¶é—´è®¾ç½®åˆç†
   - æŸ¥çœ‹ Token ä½¿ç”¨ç»Ÿè®¡æ’æŸ¥é—®é¢˜

3. **æ¨¡æ€æ¡†æ˜¾ç¤ºå¼‚å¸¸**
   - ç¡®ä¿é™æ€æ–‡ä»¶æ­£å¸¸åŠ è½½
   - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JavaScript é”™è¯¯
   - æ¸…é™¤æµè§ˆå™¨ç¼“å­˜é‡è¯•

4. **ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®**
   - æ£€æŸ¥æ•°æ®åº“æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - ç¡®è®¤è·¯ç”±ä¸­é—´ä»¶æ­£å¸¸è¿è¡Œ
   - æŸ¥çœ‹æ—¥å¿—ç¡®è®¤ç»Ÿè®¡è®°å½•æ˜¯å¦æ­£å¸¸

5. **ç³»ç»Ÿç›‘æ§æ•°æ®å¼‚å¸¸**
   - ç¡®ä¿å·²å®‰è£… `psutil` åº“
   - åœ¨å®¹å™¨ç¯å¢ƒä¸­ï¼Œéƒ¨åˆ†ç³»ç»Ÿæ•°æ®å¯èƒ½æ— æ³•å‡†ç¡®è·å–
   - æ£€æŸ¥ç³»ç»Ÿæƒé™æ˜¯å¦è¶³å¤Ÿ

## ğŸ”— ç›¸å…³èµ„æº

- [FastAPI æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Psutil æ–‡æ¡£](https://psutil.readthedocs.io/)
- [ECharts æ–‡æ¡£](https://echarts.apache.org/)
- [Jinja2 æ¨¡æ¿æ–‡æ¡£](https://jinja.palletsprojects.com/)